{% extends "main.html" %}

{% block title %}
<title>Logs Charts</title>
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="card card_form">
    <div class="card-header text-center py-2">
        <h4 class="card-title mb-0 d-flex align-items-center justify-content-center">
            <i class="bi bi-list-check ms-2"></i> Logs Charts
        </h4>
    </div>

    <div class="card-body p-3">
        <canvas id="totalLineChart" width="600" height="300"></canvas>
        <hr>
        <canvas id="resultsBarChart" width="600" height="300"></canvas>

        <script>
            fetch('/api/logs_by_day')
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(item => item.day);
                    const totalCounts = data.map(item => item.total || 0);
                    const categoryCounts = data.map(item => item.results.Category || 0);
                    const noResultCounts = data.map(item => item.results.no_result || 0);

                    // Compute percentages
                    const categoryRatios = data.map(item =>
                        item.total ? ((item.results.Category || 0) / item.total * 100).toFixed(2) : 0
                    );
                    const noResultRatios = data.map(item =>
                        item.total ? ((item.results.no_result || 0) / item.total * 100).toFixed(2) : 0
                    );

                    // Total Line Chart
                    const totalCtx = document.getElementById('totalLineChart').getContext('2d');
                    new Chart(totalCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total',
                                data: totalCounts,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Total per Day'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Total' }
                                },
                                x: {
                                    title: { display: true, text: 'Day' }
                                }
                            }
                        }
                    });

                    // Results Bar Chart + Percentages
                    const resultsCtx = document.getElementById('resultsBarChart').getContext('2d');
                    new Chart(resultsCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Category Count',
                                    data: categoryCounts,
                                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'No Result Count',
                                    data: noResultCounts,
                                    backgroundColor: 'rgba(255, 206, 86, 0.6)',
                                    borderColor: 'rgba(255, 206, 86, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: '% Category of Total',
                                    data: categoryRatios,
                                    type: 'line',
                                    yAxisID: 'percentage',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    tension: 0.3,
                                    fill: false
                                },
                                {
                                    label: '% No Result of Total',
                                    data: noResultRatios,
                                    type: 'line',
                                    yAxisID: 'percentage',
                                    borderColor: 'rgba(153, 102, 255, 1)',
                                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                    tension: 0.3,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Category & No Result with Percentages'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Counts' }
                                },
                                percentage: {
                                    position: 'right',
                                    beginAtZero: true,
                                    min: 0,
                                    max: 100,
                                    title: { display: true, text: 'Percentage (%)' },
                                    grid: { drawOnChartArea: false }
                                },
                                x: {
                                    title: { display: true, text: 'Day' }
                                }
                            }
                        }
                    });
                });
        </script>
    </div>
</div>
{% endblock %}
